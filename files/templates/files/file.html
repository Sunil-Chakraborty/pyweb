{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Document Manager</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/all.min.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .form-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .form-row .form-group {
            flex: 1;
            margin-bottom: 10px;
        }
        .breadcrumb {
            background-color: #f8f9fa;
            margin-bottom: 20px;
        }
        .btn-file {
            display: block;
            margin-top: 10px;
        }
        img {
            max-width: 100%;
            height: auto;
        }
        .iframe-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* Aspect ratio: 16:9 */
            height: 0;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        video {
            max-width: 100%;
            height: auto;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="{% url 'employee:home' %}" class="btn btn-outline-secondary btn-sm mb-3">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="mb-4">
            <a href="{% url 'files:home' %}"><i class="fas fa-home"></i></a>
            {% if current_directory %}
                {% for ancestor in current_directory.get_ancestors %}
                    / <a href="{% url 'files:directory_view' ancestor.pk %}">{{ ancestor.name }}</a>
                {% endfor %}
                / <span>{{ current_directory.name }}</span>
            {% else %}
                / <span>Home</span>
            {% endif %}
        </h1>
        <div class="row">
            <!-- Directories Section -->
            <div class="col-lg-6 col-md-12 mb-4">
                <div class="form-row">
                    <form method="POST" action="{% url 'files:add_directory' %}" class="form-inline w-100">
                        {% csrf_token %}
                        <div class="form-group flex-grow-1 mr-2">
                            <input type="text" name="name" placeholder="Enter new directory name" class="form-control w-100" required>
                            <input type="hidden" name="parent" value="{% if current_directory %}{{ current_directory.pk }}{% else %}0{% endif %}">
                        </div>
                        <button type="submit" class="btn btn-primary">New Directory</button>
                    </form>
                </div>
                <h3>List of Directories</h3>
                <table class="table table-bordered mt-3">
                    <thead>
                        <tr>
                            <th>Directory Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for directory in subdirectories %}
                            <tr>
                                <td>
                                    <a href="{% url 'files:directory_view' directory.pk %}" class="btn btn-outline-secondary btn-sm">{{ directory.name }}</a>
                                </td>
                                <td>
                                    <a href="{% url 'files:delete_directory' directory.pk %}" class="btn btn-danger btn-sm">Delete</a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Files Section -->
            <div class="col-lg-6 col-md-12 mb-4">
                <div class="form-row">
                    <form method="POST" enctype="multipart/form-data" action="{% url 'files:add_file' %}" class="form-inline w-100">
                        {% csrf_token %}
                        <div class="form-group flex-grow-1 mr-2">
                            <input type="text" name="name" placeholder="Enter new file name" class="form-control w-100 mb-2" required>
							<input type="text" name="owner" placeholder="Owner of the file" class="form-control w-100 mb-2">
                            <div class="input-group mb-2">
                                <input type="file" name="file" class="form-control-file w-100" id="file-input">
                                <input type="url" name="url" placeholder="Enter file URL" class="form-control w-100 d-none" id="url-input">
                            </div>
                            <input type="hidden" name="directory" value="{{ current_directory_id }}">
                            <button type="submit" class="btn btn-primary btn-file">New File</button>
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="file_option" id="option_file" value="file" checked>
                                <label class="form-check-label" for="option_file">
                                    Upload File
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="file_option" id="option_url" value="url">
                                <label class="form-check-label" for="option_url">
                                    Use URL
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <h3>List of Files</h3>
                <table class="table table-bordered mt-3">
                    <thead>
                        <tr>
                            <th>File Name</th>
                            <th>Preview/Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in files %}
                            <tr>
                                <td>{{ file.name }}</td>
                                <td>
                                    {% if file.url and "docs.google.com/presentation" in file.url %}
                                        <div class="iframe-container">
                                            <iframe src="{{ file.url|replace:'edit,embed' }}&start=false&loop=false&delayms=3000"
                                                    allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true">
                                            </iframe>
                                        </div>
                                    {% elif file.url and file.url|is_image %}
                                        <img src="{{ file.url }}" alt="{{ file.name }}" class="img-thumbnail mb-2">
                                    {% elif file.file and file.file.url and file.file.url|is_image %}
                                        <img src="{{ file.file.url }}" alt="{{ file.name }}" class="img-thumbnail mb-2">
                                    {% elif file.url and file.url|endswith:".mp4" %}
                                        <video controls>
                                            <source src="{{ file.url }}" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                    {% elif file.file and file.file.url and file.file.url|endswith:".mp4" %}
                                        <video controls>
                                            <source src="{{ file.file.url }}" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                    {% elif file.url %}
                                        <a href="{{ file.url }}" target="_blank" class="btn btn-outline-primary btn-sm">Open</a>
                                    {% elif file.file %}
                                        <a href="{{ file.file.url }}" target="_blank" class="btn btn-outline-primary btn-sm">Open</a>
                                    {% else %}
                                        <span class="text-danger">No file or URL associated</span>
                                    {% endif %}
                                    <a href="{% url 'files:delete_file' file.pk %}" class="btn btn-danger btn-sm">Delete</a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.0/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            $('input[name="file_option"]').on('change', function() {
                if ($(this).val() === 'file') {
                    $('#file-input').removeClass('d-none');
                    $('#url-input').addClass('d-none');
                } else {
                    $('#file-input').addClass('d-none');
                    $('#url-input').removeClass('d-none');
                }
            });
        });
    </script>
</body>
</html>
